<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Earth Login</title>
  <!-- Import Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./style.css">
</head>

<body>
  <!-- Sound Check Overlay -->
  <div id="sound-check-overlay"
    style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; font-family: 'Inter', sans-serif;">
    <h1 style="font-size: 2rem; margin-bottom: 20px; font-weight: 300; letter-spacing: 2px;">AUDIO EXPERIENCE</h1>
    <p style="margin-bottom: 40px; color: #888;">Please turn on your speakers for the full experience.</p>
    <button id="sound-ready-btn"
      style="padding: 15px 40px; background: transparent; border: 1px solid #00A4EF; color: #00A4EF; font-size: 1.2rem; cursor: pointer; transition: all 0.3s; border-radius: 4px; text-transform: uppercase; letter-spacing: 2px;">
      Initialize System
    </button>
  </div>

  <!-- 3D Canvas will be injected here by main.js (or we can specify it) -->

  <!-- Login UI Overlay -->
  <div id="login-container">
    <div class="login-content" id="login-content">
      <div class="brand"><span class="brand-pink">good</span><span class="brand-blue">talent</span><span
          class="brand-dot">.</span></div>
      <h1>Welcome Back</h1>
      <p class="subtitle">Sign in to continue to your account</p>

      <form id="login-form">
        <div class="input-group">
          <label for="email">Email Address</label>
          <div class="input-wrapper">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="input-icon">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
              <polyline points="22,6 12,13 2,6"></polyline>
            </svg>
            <input type="email" id="email" placeholder="Enter your email" required autocomplete="off">
          </div>
        </div>

        <div class="input-group">
          <label for="password">Password</label>
          <div class="input-wrapper">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="input-icon">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
            <input type="password" id="password" placeholder="Enter your password" required>
          </div>
        </div>

        <button type="submit" class="login-btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
            <polyline points="10 17 15 12 10 7"></polyline>
            <line x1="15" y1="12" x2="3" y2="12"></line>
          </svg>
          <span>Sign In</span>
        </button>
      </form>
    </div>
  </div>

  <!-- Matrix Terminal Overlay -->
  <div id="terminal-overlay">
    <div class="terminal-window">
      <div id="terminal-content"></div>
    </div>
  </div>

  <!-- Video Overlay -->
  <div id="video-overlay"
    style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; background: black; display: none; opacity: 0; transition: opacity 0.5s;">
    <video id="intro-video" style="width: 100%; height: 100%; object-fit: cover;">
      <source src="/intro.mp4" type="video/mp4">
    </video>
  </div>

  <!-- OS Loader -->
  <div id="os-loader">
    <div class="loader-content">
      <div class="loader-logo">goodtalent<span style="color:#4169e1">.OS</span></div>
      <div class="progress-bar-container">
        <div class="progress-bar" id="os-progress"></div>
      </div>
      <div class="loader-text" id="loader-text">Initializing System...</div>
    </div>
  </div>

  <script type="module" src="/main.js"></script>

  <!-- Background Music -->
  <audio id="bg-music" loop autoplay>
    <source src="./music.mp3" type="audio/mpeg">
  </audio>

  <script>
    // Audio Context Setup
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();

    function playTypingSound() {
      try {
        // Create a short blip for typing
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        osc.type = 'square';
        osc.frequency.setValueAtTime(800 + Math.random() * 200, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);

        osc.start();
        osc.stop(audioCtx.currentTime + 0.05);
      } catch (e) { console.error(e); }
    }

    function playAccessGrantedSound() {
      try {
        // Positive chord
        [440, 554, 659].forEach((freq, i) => {
          setTimeout(() => {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = 'sawtooth';
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1.0);
            osc.start();
            osc.stop(audioCtx.currentTime + 1.0);
          }, i * 50);
        });
      } catch (e) { console.error(e); }
    }


    // Login Handler
    const form = document.getElementById('login-form');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // 1. Fade UI
      document.getElementById('login-content').style.opacity = '0';
      document.getElementById('login-content').style.transition = 'opacity 0.5s';

      // 2. Soft Stop Music
      const music = document.getElementById('bg-music');
      const fadeAudio = setInterval(() => {
        if (music.volume > 0.05) {
          music.volume -= 0.05;
        } else {
          music.pause();
          clearInterval(fadeAudio);
        }
      }, 100);

      // 3. Play Video
      const videoOverlay = document.getElementById('video-overlay');
      const video = document.getElementById('intro-video');

      videoOverlay.style.display = 'block';
      // Force prompt layout
      videoOverlay.offsetHeight;
      videoOverlay.style.opacity = '1';

      try {
        await video.play();
      } catch (err) {
        console.warn("Video autoplay failed or blocked", err);
        // Fallback immediately if video fails
        onVideoEnd();
        return;
      }

      // Matrix mode (visual background change)
      if (window.setMatrixMode) window.setMatrixMode(true);

      video.onended = onVideoEnd;
      // Fallback if video fails to play or is too long/short/stuck
      setTimeout(onVideoEnd, 15000);
    });

    let sequenceStarted = false;
    const onVideoEnd = async () => {
      if (sequenceStarted) return;
      sequenceStarted = true;

      const videoOverlay = document.getElementById('video-overlay');
      videoOverlay.style.opacity = '0';
      await new Promise(r => setTimeout(r, 500));
      videoOverlay.style.display = 'none';

      startOSLoadSequence();
    };

    async function startOSLoadSequence() {
      const loader = document.getElementById('os-loader');
      loader.style.opacity = '1';
      loader.style.pointerEvents = 'auto'; // allow interaction if needed

      // Call Scene Update (Hide Earth, Keep Stars)
      if (window.startOSMode) window.startOSMode();

      // Simulate Loading
      const progressBar = document.getElementById('os-progress');
      const loaderText = document.getElementById('loader-text');
      const steps = ["Loading User Profile...", "Restoring Desktop...", "Fetching Recruiting Data...", "Starting Services...", "Welcome, Neo."];

      for (let i = 0; i <= 100; i += 2) {
        progressBar.style.width = i + '%';
        if (i % 20 === 0 && i < 100) {
          loaderText.innerText = steps[Math.floor(i / 20)];
          playTypingSound(); // Reuse sound
        }
        await new Promise(r => setTimeout(r, 30));
      }

      // 5.5 Set Mock Auth Token for Demo
      localStorage.setItem('authToken', 'demo-token');
      localStorage.setItem('user', JSON.stringify({ name: 'Neo User', email: 'neo@example.com', role: 'Admin' }));

      // 6. Redirect to OS App
      await new Promise(r => setTimeout(r, 500));

      console.log('Redirecting to dashboard now...');
      window.location.href = '/dashboard';
    }

    // Sound Experience Initialization
    document.addEventListener('DOMContentLoaded', () => {
      const overlay = document.getElementById('sound-check-overlay');
      const btn = document.getElementById('sound-ready-btn');
      const audio = document.getElementById('bg-music');
      audio.volume = 0.5;

      // Make button glow on hover
      btn.addEventListener('mouseenter', () => {
        btn.style.boxShadow = '0 0 20px rgba(0, 164, 239, 0.5)';
        btn.style.background = 'rgba(0, 164, 239, 0.1)';
      });
      btn.addEventListener('mouseleave', () => {
        btn.style.boxShadow = 'none';
        btn.style.background = 'transparent';
      });

      btn.addEventListener('click', () => {
        // 1. Resume Audio Context (for sound effects)
        if (audioCtx.state === 'suspended') {
          audioCtx.resume();
        }

        // 2. Play Music
        audio.play().then(() => {
          console.log("Audio initialized successfully");
        }).catch(e => console.error("Audio play failed:", e));

        // 3. Fade out overlay
        overlay.style.transition = 'opacity 1s ease';
        overlay.style.opacity = '0';

        // 4. Remove overlay from DOM
        setTimeout(() => {
          overlay.style.display = 'none';
        }, 1000);
      });
    });

  </script>
</body>

</html>